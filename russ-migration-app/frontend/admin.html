<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RUSS Analyser | Admin Panel</title>
  <link rel="stylesheet" href="/frontend/style.css" />

  <style>
    /* --- Header --- */
    .header {
      background: linear-gradient(to right, #003366, #0066a1);
      color: white;
      padding: 25px 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      border-bottom: 3px solid #004c7d;
    }
    .header h1 { margin: 0; font-size: 26px; font-weight: 700; }
    .tagline { margin-top: 6px; font-size: 15px; color: #e0ecf5; }
    .header-right { position: absolute; right: 40px; top: 15px; display: flex; align-items: center; gap: 15px; }
    .logo { height: 50px; width: auto; }

    /* --- Profile Dropdown --- */
    .profile-menu { position: relative; }
    .profile-icon {
      width: 40px; height: 40px; border-radius: 50%;
      background-color: #005b7f; color: white;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-weight: bold; overflow: hidden;
    }
    .profile-icon img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none; }
    .dropdown {
      position: absolute; top: 50px; right: 0;
      background: white; color: #003366; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none; flex-direction: column; width: 180px; z-index: 10;
      opacity: 0; transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .dropdown a { padding: 10px; text-decoration: none; color: #003366; border-bottom: 1px solid #eee; }
    .dropdown a:hover { background: #f2f8fb; }
    .profile-menu.active .dropdown { display: flex; opacity: 1; transform: translateY(0); }

    /* --- Tabs --- */
    .tabs { display: flex; justify-content: center; margin: 20px 0; gap: 20px; }
    .tab-btn {
      background: #e8f0f8; color: #003366; border: 2px solid #0066a1;
      padding: 10px 18px; border-radius: 8px; cursor: pointer;
      font-weight: 600; transition: all 0.2s ease;
    }
    .tab-btn.active { background: #0066a1; color: white; }

    /* --- Containers --- */
    .container {
      max-width: 1100px; margin: 20px auto; background: #fff;
      padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #003366; margin-bottom: 20px; }

    /* --- Table --- */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; cursor: default; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background: #f2f8fb; color: #003366; cursor: pointer; position: relative; }
    th.sortable:hover { background: #e0ebf5; }
    th.sorted-asc::after, th.sorted-desc::after {
      content: ''; position: absolute; right: 8px; border: 5px solid transparent;
    }
    th.sorted-asc::after { border-bottom: 6px solid #003366; top: 35%; }
    th.sorted-desc::after { border-top: 6px solid #003366; top: 55%; }

    /* --- Buttons --- */
    .btn {
      display: inline-block; padding: 8px 14px; margin: 3px;
      background-color: #006994; color: #fff; border-radius: 6px;
      font-weight: 600; border: none; cursor: pointer; transition: 0.3s;
    }
    .btn:hover { background-color: #005b7f; }
    .btn-delete { background-color: #d93025; }
    .btn-delete:hover { background-color: #b12419; }
    .btn-admin { background-color: #007f4f; }
    .btn-admin:hover { background-color: #00663f; }
    .btn-remove-admin { background-color: #ff9800; }
    .btn-remove-admin:hover { background-color: #e68900; }

    .footer { text-align: center; margin-top: 60px; padding: 10px 0; font-size: 14px; color: #666; }
    .hidden { display: none; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1>RUSS Analyser</h1>
      <p class="tagline">Admin Panel â€” Manage Users & Reports</p>
    </div>
    <div class="header-right">
      <div class="profile-menu" id="profileMenu">
        <div class="profile-icon" id="profileIcon">
          <img id="user-avatar-img" src="" alt="User Avatar" />
          <span id="user-avatar-letter">U</span>
        </div>
        <div class="dropdown">
          <a href="/frontend/profile.html">Profile Settings</a>
          <a href="/frontend/dashboard.html">Dashboard</a>
          <a href="/frontend/index.html">Main Tool</a>
          <a href="#" id="logoutBtn">Logout</a>
        </div>
      </div>
      <img src="/frontend/assets/russ_logo-removebg-preview.png" class="logo" alt="RUSS Consultancy Logo" />
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tab-users" class="tab-btn active">ðŸ‘¥ User Management</button>
    <button id="tab-reports" class="tab-btn">ðŸ“‹ Reports & Analytics</button>
  </div>

  <!-- USER TAB -->
  <main id="user-tab" class="container">
    <h2>ðŸ‘‘ Admin â€” User Management</h2>
    <div id="admin-feedback" style="color:green; text-align:center;"></div>

    <div style="margin-bottom:20px; text-align:center;">
      <label style="font-weight:600; color:#003366;">Admin Email:</label>
      <input id="admin-email" type="email" placeholder="Admin email" style="width:200px; margin-right:10px;" />
      <label style="font-weight:600; color:#003366;">Password:</label>
      <input id="admin-password" type="password" placeholder="Password" style="width:200px; margin-right:10px;" />
      <button id="admin-load-users" class="btn">Load Users</button>
    </div>

    <table id="admin-users-table">
      <thead>
        <tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <!-- REPORTS TAB -->
  <main id="reports-tab" class="container hidden">
    <h2>ðŸ“Š Reports & Analytics</h2>

    <div style="text-align:center; margin-bottom:20px;">
      <input id="filter-email" placeholder="Filter by email" style="padding:5px;" />
      <select id="filter-cloud">
        <option value="">All Clouds</option>
        <option value="azure">Azure</option>
        <option value="aws">AWS</option>
        <option value="oci">OCI</option>
      </select>
      <button id="apply-report-filters" class="btn">Apply Filters</button>
      <button id="clear-report-filters" class="btn" style="background:#555;">Clear</button>
      <button id="export-csv" class="btn" style="background:#007f4f;">â¬‡ Export CSV</button>
    </div>

    <table id="report-table">
      <thead>
        <tr>
          <th class="sortable">Date</th><th class="sortable">User</th><th class="sortable">Cloud</th>
          <th>Source</th><th class="sortable">vCPUs</th><th class="sortable">Memory</th>
          <th>IOPS</th><th>Throughput</th><th>Recommended VM</th>
          <th>VM vCPUs</th><th>VM Memory</th><th>Category</th><th class="sortable">Monthly Cost</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer class="footer">Â© 2025 RUSS Consultancy Services | Experience At Work</footer>

  <script src="/frontend/script.js"></script>

  <script>
    // --- Tabs toggle ---
    document.getElementById("tab-users").addEventListener("click", () => {
      document.getElementById("tab-users").classList.add("active");
      document.getElementById("tab-reports").classList.remove("active");
      document.getElementById("user-tab").classList.remove("hidden");
      document.getElementById("reports-tab").classList.add("hidden");
    });

    document.getElementById("tab-reports").addEventListener("click", () => {
      document.getElementById("tab-reports").classList.add("active");
      document.getElementById("tab-users").classList.remove("active");
      document.getElementById("reports-tab").classList.remove("hidden");
      document.getElementById("user-tab").classList.add("hidden");
      loadReports();
    });

    // --- Load Reports ---
    async function loadReports() {
      const tbody = document.querySelector("#report-table tbody");
      tbody.innerHTML = "<tr><td colspan='13' style='text-align:center;'>Loading...</td></tr>";

      const email = document.getElementById("filter-email").value.trim();
      const cloud = document.getElementById("filter-cloud").value.trim();
      const params = new URLSearchParams();
      if (email) params.append("email", email);
      if (cloud) params.append("cloud", cloud);

      try {
        const res = await fetch(`/api/reports?${params.toString()}`);
        const data = await res.json();
        tbody.innerHTML = "";

        if (!data.reports || !data.reports.length) {
          tbody.innerHTML = "<tr><td colspan='13' style='text-align:center; color:gray;'>No reports found.</td></tr>";
          return;
        }

        data.reports.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : "-"}</td>
            <td>${r.user_email || "unknown"}</td>
            <td>${r.cloud || "-"}</td>
            <td>${r.source || "-"}</td>
            <td>${r.vcpus || "-"}</td>
            <td>${r.memory || "-"}</td>
            <td>${r.iops || "-"}</td>
            <td>${r.throughput || "-"}</td>
            <td>${r.recommended_vm || "-"}</td>
            <td>${r.vm_vcpus || "-"}</td>
            <td>${r.vm_memory || "-"}</td>
            <td>${r.category || "-"}</td>
            <td>${r.monthly_cost || "-"}</td>
          `;
          tbody.appendChild(tr);
        });

        enableSorting();
      } catch (err) {
        tbody.innerHTML = "<tr><td colspan='13' style='text-align:center; color:red;'>Error loading reports.</td></tr>";
        console.error("Load reports failed:", err);
      }
    }

    // --- Filter Actions ---
    document.getElementById("apply-report-filters").addEventListener("click", loadReports);
    document.getElementById("clear-report-filters").addEventListener("click", () => {
      document.getElementById("filter-email").value = "";
      document.getElementById("filter-cloud").value = "";
      loadReports();
    });

    // --- Sorting ---
    function enableSorting() {
      const table = document.getElementById("report-table");
      const headers = table.querySelectorAll("th.sortable");
      headers.forEach(header => {
        header.addEventListener("click", () => {
          const index = Array.from(header.parentNode.children).indexOf(header);
          const isAsc = !header.classList.contains("sorted-asc");
          headers.forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
          header.classList.add(isAsc ? "sorted-asc" : "sorted-desc");
          sortTableByColumn(table, index, isAsc);
        });
      });
    }

    function sortTableByColumn(table, colIndex, asc = true) {
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const dir = asc ? 1 : -1;

      rows.sort((a, b) => {
        const A = a.children[colIndex].innerText.trim();
        const B = b.children[colIndex].innerText.trim();
        const numA = parseFloat(A.replace(/[^\d.]/g, ""));
        const numB = parseFloat(B.replace(/[^\d.]/g, ""));
        if (!isNaN(numA) && !isNaN(numB)) return (numA - numB) * dir;
        return A.localeCompare(B) * dir;
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    // --- CSV Export ---
    document.getElementById("export-csv").addEventListener("click", () => {
      const table = document.getElementById("report-table");
      const rows = Array.from(table.querySelectorAll("tr"));
      if (rows.length <= 1) {
        alert("No data available to export.");
        return;
      }

      const csvContent = rows.map(row =>
        Array.from(row.querySelectorAll("th, td"))
          .map(cell => `"${cell.innerText.replace(/"/g, '""')}"`)
          .join(",")
      ).join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `reports_export_${new Date().toISOString().split("T")[0]}.csv`;
      link.click();
    });
  </script>
</body>
</html>
